---
output: 
  pdf_document:
    citation_package: natbib
    keep_tex: true
    fig_caption: true
    latex_engine: pdflatex
    template: ./svm-latex-ms.tex
title: "factorMerger: a set of tools to support results from post hoc testing"
author:
- name: Agnieszka Sitko
  affiliation: University of Warsaw
abstract: "*ANOVA*-like statistical tests for differences among groups are available for almost a hundred years. But for large number of groups the results from commonly used post-hoc tests are often hard to interpret. To deal with this problem, the **factorMerger** package constructs and plots the hierarchical relation among compared groups. Such hierarchical structure is derived based on the *Likelihood Ratio Test* and is presented with the *Merging Paths Plots* created with the **ggplot2** package. The current implementation handles univariate and multivariate gaussian models as well as binomial and survival models. This article presents the theory and examples for a single-factor use cases.
\\
\\

*Package webpage*: https://github.com/geneticsMiNIng/FactorMerger"
keywords: "analysis of variance (ANOVA), hierarchical clustering, likelihood ratio test (LRT), post hoc testing"
date: "`r format(Sys.time(), '%B %d, %Y')`"
geometry: margin=1in
fontfamily: mathpazo
fontsize: 11pt
# spacing: double
bibliography: ../factorMerger.bib
biblio-style: apsr
---

```{r, echo = FALSE}
knitr::opts_chunk$set(collapse = TRUE, comment = "#>", warning = FALSE, message = FALSE, fig.height = 7, fig.width = 7)
```

# Introduction

If data is analysed using ANOVA a more detailed analysis of differences among categorical variable levels might be needed. The traditional approach will be to perform *pairwise post hocs* - multiple comparisons after ANOVA. For each pair of groups we run specific statistical test which outputs with an information whether response averages in those groups are significantly different. However, if we look from the distant perspective, for a certain significance level, these results may not be consistent. One may consider the case that mean in group A does not differ significantly from the one in group B, similarly with groups B and C. In the same time difference between group A and C is detected. Then data partition is unequivocal and, as a consequence, impossible to put through. 

The problem of clustering categorical variable into non-overlapping groups has already been present in statistics. First, J. Tukey proposed an iterative procedure of merging factor levels based on studentized range distribution [@Tukey]. However, statistical test used in this approach made it limited to gaussian models. Collapse And Shrinkage in ANOVA (CAS-ANOVA, @Casanova) is an algorithm that extends categorical variable partitioning for generalized linear models. It is based on the Tibshirani's Fused LASSO [@Tib] with the constraint taken on the pairwise differences within a factor, which yields to their smoothing.

Delete or Merge Regressors algorithm [@Proch] is also adjusted to generalized linear models. It directly uses hierarchical clustering to gain hierarchical structure of a factor. At the beginning, *DMR4glm* calculates likelihood ratio test statistics for models arising from pairewise merging of factor levels against the initial model (the one with all groups included). Then performs agglomerative clustering taking LRT statistic as a distance --- each step of clustering is associated with model with different factor structure. Experimental studies [@ProchEx] showed that Delete or Merge Regressors's performance is better than CAS-ANOVA's when it comes to model accuracy.

**factorMerger** package gives an approximate implementation of *DMR4glm*. In addition to the base algorithm, it also provides its sequential version, which merges only those levels which are relatively close (levels distance is dependent on the model chosen). While the basic approach (all vs. all comparisons) may sometimes result in a slightly better partition from the statistical point of view, proposed extention (all vs. subsequent comparisons) seems to be more graceful when it comes to the interpretation. Moreover, the former is more computationally expensive.

Furthermore, **factorMerger** offers yet another algorithm of hierarchical clustering. This is also an iterative procedure, but in each step it chooses model with the highest likelihood. While this algorithm is more complex than *DMR4glm* it is easily expandable for non-parametric models (using permutation tests instead of LRTs). The greedy algorithm is also available in two versions - comprehensive and sequential.

More detailed description of all algorithms implemented in **factorMerger** is given in the section *Algorithms overview*.


# Algorithms overview

## Sequential version 

In the sequential version of the algorithm at the begining categorical variable is releveled. Depending on the model family chosen, we specify different statistics to set levels order. 

```{r, echo = FALSE}
metrics <- data.frame(
    model = c("single dimensional gaussian", 
              "multi dimensional gaussian",
              "binomial", "survival"),
    metric = c("mean", "mean of isoMDS fit", 
               "success proportion", "relative survival coefficient"))

knitr::kable(metrics, align = "c")
```

For single dimensional gaussian and binomial models groups are sorted by means and proportions of success, respectively. In survival case we estimate survival model which takes all factor levels separately. Then beta coefficient approximations specify levels order (base level gets coefficient equal to zero). Multi dimensional gaussian model needs additional preprocessing. We propose to order levels by means of isoMDS projection (into one dimension, currently isoMDS from package **MASS** is used). However, the projection is used only in this preliminary stage. In the merging phase of the algorithm all test statistics are calculated for multi dimensional gaussian model. Calculating isoMDS projection is an expensive procedure --- it usually takes more time than the merging phase.

Having set the factor order, we may limit number of comparisons in each step.

## DMR4glm

## Greedy algorithm

## Cost comparisons


# The *R* package **factorMerger**

## Setting up merging options

## Visualizations

## Sample results

# Possible extensions

# Bibliography

